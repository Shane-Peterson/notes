# 加快网站速度的常见技巧

![catch-22](./images/catch-22.jpg)

Web 性能优化所研究的就是如何让你的页面展示的更快。

从你在地址栏输入 baidu.com 的那一刻到页面展示，经历了哪些阶段，把这些阶段都加快就行了。

## DNS 服务优化

DNS 查询，也就是说我得知道 `baidu.com` 的服务器在哪里，我要得到一个 IP，这个 IP 就是服务器所在的机房给它分配的一个公网 IP。DNS 是哪来的呢？是电信默认给你配的一个服务。那么这个东西能加速吗？可以，只要你能够提供更快的 DNS 服务，那么我在访问这个网址的时候会更快。
        
## keep-alive

给这个 IP 发起一个请求，这是一个什么请求呢？这是一个 http 请求。请问 http 请求的底层协议是什么呢？http 请求本质上是 TCP 的连接，这没得优化，因为你必须要发 TCP 的请求。但是有一个优化，我要发几个请求呢？以访问一个普通的网站为例，首先要请求一个 HTML，HTML 让你再去请求一个 CSS，CSS 加载完了之后，让你再去请求一个 JS。有什么问题呢？是不是每请求一个都要建立 TCP 连接。这有什么优化空间吗？有，如果我这三个都用一个 TCP 连接是不是就可以，这就是连接复用。怎么做到呢？你得了解一些 TCP 的细节，比如 keep-alive ，具体的意思就是既然我和百度要建立 TCP 连接，那我就不要中断呗，当你发第二个请求的时候，我再复用这个连接不就行了吗。

## SQL 优化

百度服务器收到请求之后，它可能要去查询数据库，百度查询数据库可能要用 100ms，也可能要用 1s，也可能要用 10s。这能不能优化？当然可以优化，这就叫 SQL 优化。如果你发现是后端问题，就让后端去优化，我前端不管这个事情。

## 压缩与提高服务器带宽

后端拿到数据之后是不是要返回给前端，返回能不能优化？可以，我们知道时间等于下载量除以速度，如果我们能把下载量变小，是不是就把时间变短了，或者你把速度增大，是不是时间也会变短。但是速度增大，它就分两个速度了，第一个是我们这边的服务器的下载速度，第二个为用户的带宽。用户带宽你能增大吗？你提示一个“用户，你的带宽只有 10MB，请去电信升个级！”这不可能吧，所以你只能提高你的服务器的带宽。

## 优化 CSS

下载之后呢？浏览器下载一个 HTML 之后干嘛，是不是要展示 HTML，那么请问展示的时候能不能优化？比如说我要展示一个 h1标签，那么就是一个 h1，所以这基本上没有办法优化，但是呢，你还有 CSS 啊，h1 还有 CSS 啊，那么你 CSS 怎么写的呢？你是不是有可能有多个 CSS，有多个文件，而这些 CSS 还是冲突的，比如
        
```css
h1 {
  color: red
}
```
        
```css
h1 {
  color: blue
}
```
        
这会有什么问题呢？浏览器第一次发现 a.css 的时候就把它渲染成 红色，第二次发现 b.css 的时候又把它渲染成蓝色，这需不需要时间，渲染是不是需要时间？所以我们就想了一个办法，我能不能优化 CSS，怎么优化呢？比如说，重复的选择器尽量合并，重复的属性尽量合并。

到底怎么优化？有一些优化 CSS 的 node.js 的包可以去用，但基本上没有人用，因为这个手段不靠谱。比如有的时候你的 CSS 是写在 JS 里面的，所以你可能优化来优化去，最后也没有什么效果，所以这只是一个理论上可行，面试的时候也可以答的优化。

## 加载顺序与懒加载

除了 HTML、CSS、还有 JS，一个页面肯定有这三个东西，那我怎么去优化它的顺序呢？这你就要想到用户习惯了，一般用户是怎么浏览网页的：

  1. 拿一个鼠标，先点一下地址栏。
  2. 然后拿键盘敲，或者说你有一个导航栏，你直接在导航栏上点。
  3. 最后手就不动了，用眼睛看。
        
她用眼睛看的过程中，手是不动的。手不动说明什么呢？说明她不会去点击按钮，没有人会在页面打开后，立马去点击一个按钮。这给我们的启发就是，我们能不能先把她看得见的内容给渲染出来，然后再去加载那些鼠标动作，因为用户在看网页的时候，不会马上拿起鼠标去点击，所以既然她不点击，我就先不加载 JS，我先加载 CSS。除此之外还有一个启发，用户既然是先看再动，说明她看不见第二屏对不对？那我就先不加载第二屏，这样做的好处就是第一屏加载的更快，因为用户不会一开始就看最后一页。

## 预加载  

用户加载这些之后，是不是还会点击？比如她会点击“下一页”，我能不能在用户点“下一页”之前，就去把下一页给请求下来，这样当她点下一页的时候，就秒开！这就是预加载。当然这样做有一个后果，那就是浪费带宽，它会浪费一些带宽，这就需要你自己来权衡了。

## 缓存

用户做完这些事情之后，她是不是可能就已经下单了什么的，然后，她是不是就关掉了浏览器。第二天她是不是会再打开，那么再打开的时候，难道我们要从第一步重新再做一遍吗？既然她会再打开，那能不能做缓存呢，缓存什么呢？从最开始就开始缓存。DNS 能不能缓存？可以，浏览器会自动缓存，浏览器如果请求过百度，一段时候之内，它不会再次去问，比如十分钟之内，它不会再去问 `baidu.com` 是哪一个 IP，所以这个事情我们没有办法优化，浏览器就已经自己做了。

TCP 连接可以缓存吗？不能缓存，你断了就是断了。但是，HTTP 是可以缓存的。你的 HTML/CSS/JS/图片，都是通过 HTTP 下载到浏览器的，那你能不能跟浏览器说“请帮我缓存一下”，这样用户第二次进来的时候，就不用下载了。

## 加域名

我们的用户在访问一个网站的时候，要请求很多文件，比如有 1 个HTML，10 个 CSS，20 个 JS，理论上讲一共要发 31 个请求。怎么优化，怎么让 31 个请求发的更快？很简单，我一次性发 31 个。这样做的好处就是节约时间，但有一个问题，那就是消耗用户的带宽也消耗服务器的带宽，所以每个浏览器都会做限制，每个域名同时最多 10个（也可能 8 个，10只是概数）。

因此 31 个会分成 `10 10 10 1`，分成 4 次发送，这样做的问题就是时间太长了，时间长了怎么办？优化呀。怎么优化？既然每个域名能发 10 个，那我给你搞 4 个域名不就行了嘛。这样我就可以 a 域名专门请求 HTML （一个请求），b 域名专门请求 CSS（10 个请求），c 域名专门请求 JS（10 个请求，因为我有 20 个 JS，发两遍），所以 31 个文件，我需要发 2 次请求就可以了。

为什么要加域名，因为域名的最大并发请求数有限制，既然你限制的是域名，那我就加域名，这样我的并发请求数就变大了。但是加域名会增大 DNS 的时间，因为一个域名要请求一次 DNS，那四个域名不是要请求 四次 DNS 吗？所以你要做权衡，你加了域名之后 DNS 增加的时间比你节约的时间要少，那你就赚了。一般来说都是赚的，因为 DNS 很快，所以基本上不会增加多少时间。

你分了域名之后的第二个好处就是 cookie-free，一般来说我们的所有网站上都会种下 Cookie，Cookie 会随着请求上传。当用户请求服务器时，她是要带一些信息的，一个请求大概就是 1kb、2kb、3kb 这么大，但 Cookie 可以带 4kb。如果我们在某个域名下有 4kb 的 Cookie，那么就会有一个问题，每次请求都要把这 4kb 的 Cookie 上传到服务器，我们有 31 个请求，就是 124kb，上传量变大，时间就会变长。由于我们多了一个域名，比如叫 y2，y2 是没有 Cookie 的，因为 Cookie 是跟着主域名走的。这样做的好处就是所有的 CSS 和 JS 无 Cookie，无 Cookie 就意味着不用上传那 4kb 的大小。无 Cookie 的英文名就是 Cookie-free。


## 总结

1. DNS 服务优化，如何优化？花钱。一般来说没人做 DNS 服务优化，因为它已经够快了。但是作为用户呢，你可以自己加速自己的 DNS 服务，你可以买一些加速器，它会加速你的 DNS；你还可以配 hosts，比如说你想访问 baidu.com，如果你在你的 hosts 中直接把 IP 配好，那么就没有 DNS 查询的过程了。
2. 让后端去做 keep-alive 相关的事情。他就是配一下他的 tcp。
3. SQL 优化。
4. 压缩，开启压缩算法，比如 Gzip。怎么开启呢，如果你是 Nginx，就可以搜索 Nginx Gzip。
5. 提高服务器带宽。
6. 优化 CSS。
7. 先加载 CSS，后加载 JS。
8. 先不加载第二屏，也就是懒加载。
9. 预加载。
10. 给 CSS/JS/图片 加 HTTP 缓存。HTML 永远不做缓存，因为 HTML 缓存了，你就没有机会去更新你的 CSS 和 JS 了。
11. 加域名，加域名的第一个好处就是并发量变大，第二个好处就是 Cookie-free。